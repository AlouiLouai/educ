# EduDocs Market | Gemini Spec

## 1. Context & Tech Stack
- **Framework:** Next.js 15.0.5 (App Router).
- **Backend:** Supabase (Auth, PostgreSQL, RLS, SSR).
- **Styling:** Tailwind CSS 3.4 + Shadcn UI + Radix UI.
- **Animations:** Framer Motion.
- **State Management:** URL-driven state for filtering; Server-first data fetching via Server Components.
- **Type Safety:** TypeScript 5.4.

## 2. Database Schema (Public)
### `public.profiles`
- `id`: `uuid` (Primary Key, Foreign Key to `auth.users.id`).
- `first_name`: `text` (Nullable).
- `last_name`: `text` (Nullable).
- `email`: `text` (Nullable).
- `role`: `text` (Nullable) - Constraint: `student`, `teacher`, `admin`.
- `avatar_url`: `text` (Nullable).
- `created_at`: `timestamptz` (Default: `now()`).
- `updated_at`: `timestamptz` (Default: `now()`).

*Note: RLS is enabled on all public tables.*

## 3. Auth & Role Architecture
- **Provider:** Google OAuth + PKCE Flow.
- **Role Management:**
  - Captured during signup via URL params (`?role=teacher` | `student`).
  - Persisted in `public.profiles` and `auth.users.app_metadata.role`.
  - **Role Locking:** Once a profile is created, the user is locked to that role. Attempts to sign up with a different role redirect to the existing role's dashboard.
- **Session Persistence:** 
  - `@supabase/ssr` handles cookie-based sessions.
  - Custom cookies `edudocs_role` and `edudocs_profile` are used for fast middleware checks.

## 4. Security Architecture
- **Middleware Protection:** 
  - `src/middleware.ts` guards `/teacher`, `/student`, and `/admin` routes.
  - Multi-source role verification: `app_metadata`, `user_metadata`, and `edudocs_role` cookie.
- **Admin Access:** `src/lib/supabase/admin.ts` provides a Service Role client for bypass-RLS operations (use with extreme caution).
- **Role Enforcement:** Strict whitelisting in `src/app/auth/callback/route.ts`.

## 5. Coding Standards
- **Components:** 
  - Prefer Server Components for data fetching (`src/lib/supabase/server.ts`).
  - Use `src/lib/supabase/browser.ts` for client-side interactions.
- **Loading & Performance:**
  - **Skeletons:** Every route must have a `loading.tsx` file providing a structural skeleton that matches the final UI.
  - **Streaming:** Use React `Suspense` for data-heavy components (e.g., lists, tables) to allow the page shell to load immediately.
  - **CLS Prevention:** Skeletons must strictly match the dimensions of the final rendered content to prevent Cumulative Layout Shift.
- **Types:** Centralized in `src/types/index.ts`.
- **Styling:** Use `cn()` utility for Tailwind class merging; keep logic in `src/lib`.
- **Data:** Mock data for UI development in `src/lib/data/mock.ts`.

## 6. Directory Map
- `src/app/(admin)`: Admin-only dashboard.
- `src/app/(student)`: Student-specific features.
- `src/app/(teacher)`: Teacher-specific features.
- `src/app/auth`: Callback, Signout, and Account deletion routes.
- `src/components/auth`: Multi-role auth modal logic.
- `src/components/ui`: Atomic Shadcn components.

---
*Generated by Gemini CLI - Updated Feb 21, 2026*

