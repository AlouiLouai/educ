# EduDocs Market | Gemini AI Spec

## 1. Context & Tech Stack
- **Framework:** Next.js 15.1 (App Router, Turbopack).
- **Backend:** Supabase (Auth, PostgreSQL, RLS, SSR).
- **Styling:** Tailwind CSS 3.4 + Shadcn UI + Radix UI.
- **Animations:** Framer Motion (PopLayout, Layout transitions).
- **Notifications:** Sonner (Global Top-Center Toaster).
- **State Management:** React Server Components (RSC) for data fetching; URL-driven state for filtering.
- **Type Safety:** TypeScript 5.4.

## 2. Database Schema (Public)

### `public.profiles`
- `id`: `uuid` (PK, FK to `auth.users.id`).
- `first_name`, `last_name`, `email`, `avatar_url`: `text`.
- `role`: `text` (`student`, `teacher`, `admin`).
- `created_at`, `updated_at`: `timestamptz`.

### `public.documents`
- `id`: `uuid` (PK).
- `teacher_id`: `uuid` (FK to `profiles.id`).
- `title`, `description`: `text`.
- `price`: `numeric` (TND).
- `storage_path`: `text` (Path in `docs` bucket).
- `file_type`: `text` (MIME type).
- `file_size`: `bigint`.
- `status`: `text` (`draft`, `published`, `archived`).
- `metadata`: `jsonb` (Contains `grade`, `subject`, `original_name`).
- `created_at`: `timestamptz`.

*Note: RLS is strictly enabled. `auth.uid() = id` for profiles and `auth.uid() = teacher_id` for document management.*

## 3. High-Performance Auth Architecture

### A. Identity & Verification
- **Verified Fetching:** Always use `supabase.auth.getUser()` in Server Components/Middleware. `getSession()` is deprecated for security-sensitive logic.
- **Parallel Hydration:** `RootLayout` fetches user and profile concurrently using `Promise.all`. The profile fetch leverages RLS (no explicit ID filter required) to minimize request latency.
- **Request Deduplication:** The Supabase server client is wrapped in `React.cache`, ensuring `getUser()` is only called once per request across Layouts and Pages.

### B. Intelligent Role Management
- **Role Locking:** Enforced in `/auth/callback`. Users are bound to the role created during signup.
- **Persistent Role Hinting:** The `edudocs_role` cookie is **not** cleared on signout. It serves as a UI hint to default the "Sign In" flow to the correct role (Teacher vs Student).
- **Context-Aware Detection:** `AuthSync` detects the requested role by checking (1) URL Path, (2) `edudocs_role` cookie, then (3) defaulting to `student`.

## 4. Scalable Document Upload System

### A. Concurrency & Queueing
- **Client-Side Queue:** Implements a strict `CONCURRENCY_LIMIT = 3` for parallel uploads. This prevents browser network saturation and Supabase API rate-limiting for batch uploads (e.g., 50+ files).
- **Simulated Progress:** individual file progress bars with intelligent simulation during transfer, snapping to 100% upon DB confirmation.

### B. Live Loading (Optimistic UI)
- **Real-time Injection:** Individual successful uploads trigger an `onItemUploaded` callback.
- **No-Refresh Updates:** New documents are injected directly into the dashboard state array, appearing instantly behind the modal.
- **Silent Revalidation:** `router.refresh()` is called in the background after modal closure to sync server-side stats without blocking the UI.

### C. Reliability & UX
- **Compensating Transactions:** If a database insertion fails after a successful storage upload, the system automatically deletes the orphaned file from the bucket.
- **Batch Feedback:** Uses `sonner` to display a single, clear toast summarizing the total number of successful uploads once the queue is empty.
- **Automatic Closure:** The upload modal closes automatically 500ms after a successful batch completion to streamline the workflow.

## 5. UI/UX Standards
- **Simple & Attractive Dashboard:** Focused "Studio" layout with a 1-column main list and a sidebar for contextual info (Revenue, Pro Tips).
- **Premium Components:** Uses `3xl` rounded corners, soft shadows (`shadow-soft`), and subtle gradients (`accent-4/30`).
- **Form UX:** "Nouveau document" modal uses a compact 3-column metadata grid and a slimmed-down drag-and-drop zone to minimize height.
- **Education Metadata:** Pre-populated dropdowns for Tunisian grades (1Ã¨re primaire to Bac) and core subjects (Maths, Physique, etc.).

## 6. Directory Map
- `src/app/(student)/student`: Student dashboard.
- `src/app/(teacher)/teacher`: Teacher studio (Server Component for speed).
- `src/components/teacher`: Upload logic and Studio client components.
- `src/components/providers`: Auth context and Sonner Toaster.
- `src/lib/supabase`: Memoized server and browser clients.

---
*Generated by Gemini CLI - Updated Feb 25, 2026*
