# EduDocs Market | Gemini Spec

## 1. Context & Tech Stack
- **Framework:** Next.js 15.0.5 (App Router).
- **Backend:** Supabase (Auth, PostgreSQL, RLS, SSR).
- **Styling:** Tailwind CSS 3.4 + Shadcn UI + Radix UI.
- **Animations:** Framer Motion.
- **State Management:** URL-driven state for filtering; Server-first data fetching via Server Components.
- **Type Safety:** TypeScript 5.4.

## 2. Database Schema (Public)
### `public.profiles`
- `id`: `uuid` (Primary Key, Foreign Key to `auth.users.id`).
- `first_name`: `text` (Nullable).
- `last_name`: `text` (Nullable).
- `email`: `text` (Nullable).
- `role`: `text` (Nullable) - Constraint: `student`, `teacher`, `admin`.
- `avatar_url`: `text` (Nullable).
- `created_at`: `timestamptz` (Default: `now()`).
- `updated_at`: `timestamptz` (Default: `now()`).

*Note: RLS is enabled on all public tables. Access is restricted to `auth.uid() = id`.*

## 3. Advanced Auth Architecture (Senior Grade)
### A. Identity Verification
- **Strict Security:** Always use `supabase.auth.getUser()` in Server Components, Middleware, and Auth initialization. Do **not** rely on `getSession()` for identity-sensitive logic as it only reads from local storage/cookies without server verification.
- **Server Hydration:** `src/app/layout.tsx` fetches the user session and profile on the server. This data is passed to `AuthProvider` as `initialSession` and `initialProfile` to prevent UI flickering (FOUC) and hydration mismatches.

### B. Role Management & Security
- **Role Locking:** Managed in `src/app/auth/callback/route.ts`. Roles are persisted in both `public.profiles` and `auth.users.app_metadata.role`.
- **Metadata Source of Truth:** `app_metadata` is signed by Supabase and is the primary source for role-based protection.
- **Fast Re-entry:** Google OAuth is configured without the `prompt: "select_account"` parameter for seamless re-login. Sign-out uses `{ scope: 'local' }` to keep the Google session active in the browser.

### C. Client State & Sync
- **AuthProvider (`src/components/providers/auth-provider.tsx`):**
  - **Realtime Sync:** Subscribes to the specific profile row (`id=eq.userId`) for instant UI updates when data changes in the database.
  - **Retry Logic:** Implements a 1-second retry for profile fetching to account for eventual consistency during the initial signup redirect.
- **Data Normalization:** `src/lib/user/connected-user.ts` provides a consistent `ConnectedUser` object, decoupling the UI from raw Supabase types.

## 4. Security Architecture
- **Middleware Protection:** 
  - `src/lib/supabase/middleware.ts` guards `/teacher`, `/student`, and `/admin` routes.
  - Uses `getUser()` to ensure the session is authentic.
- **Hydration Safety:** 
  - `html` tag in `layout.tsx` uses `suppressHydrationWarning`.
  - Client components (like `SiteHeader`) use a `mounted` state check for role-specific links to prevent `href` mismatches between server and client.

## 5. UI/UX Standards
- **Navigation Logic:**
  - Logo ("EduDocs Market") always redirects to the home page (`/`).
  - Home page displays dynamic "Return to Dashboard" buttons for authenticated users.
- **Loading & Performance:**
  - **Skeletons:** Every route must have a `loading.tsx`. Skeletons must match the final layout dimensions to prevent Cumulative Layout Shift (CLS).
  - **Streaming:** Use React `Suspense` for data-heavy components (e.g., `DocumentList`).

## 6. Directory Map
- `src/app/(student)/student`: Student dashboard and features.
- `src/app/(teacher)/teacher`: Teacher studio and management.
- `src/components/providers`: Centralized context providers (Auth, etc.).
- `src/lib/supabase`: Server, Browser, and Middleware client factories.
- `src/lib/user`: User-related utilities and normalization.

---
*Generated by Gemini CLI - Updated Feb 23, 2026*
